<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-100.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-50.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.20/fancybox/fancybox.css" integrity="sha256-RvRHGSuWAxZpXKV9lLDt2e+rZ+btzn48Wp4ueS3NZKs=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liu-paopao.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="boost 协程上下文切换 make_arm64_aapcs_elf_gas.S 和 jump_arm64_aapcs_elf_gas.S 以及 make_x86_64_aapcs_elf_gas.S 和 jump_x86_64_aapcs_elf_gas.S 汇编源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="boost 协程中 arm64 和 x86_64 架构汇编实现">
<meta property="og:url" content="https://liu-paopao.github.io/posts/4059c7aa.html">
<meta property="og:site_name" content="PaoPao&#39;s Blog">
<meta property="og:description" content="boost 协程上下文切换 make_arm64_aapcs_elf_gas.S 和 jump_arm64_aapcs_elf_gas.S 以及 make_x86_64_aapcs_elf_gas.S 和 jump_x86_64_aapcs_elf_gas.S 汇编源码分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212231034473.gif">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212231034473.gif">
<meta property="article:published_time" content="2022-12-05T14:35:05.000Z">
<meta property="article:modified_time" content="2022-12-23T02:36:15.063Z">
<meta property="article:author" content="paopao">
<meta property="article:tag" content="协程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212231034473.gif">


<link rel="canonical" href="https://liu-paopao.github.io/posts/4059c7aa.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://liu-paopao.github.io/posts/4059c7aa.html","path":"posts/4059c7aa.html","title":"boost 协程中 arm64 和 x86_64 架构汇编实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>boost 协程中 arm64 和 x86_64 架构汇编实现 | PaoPao's Blog</title>
  







<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css" />
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">PaoPao's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-folder-open fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#make-arm64-aapcs-elf-gas-S"><span class="nav-number">1.</span> <span class="nav-text">make_arm64_aapcs_elf_gas.S</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jump-arm64-aapcs-elf-gas-S"><span class="nav-number">2.</span> <span class="nav-text">jump_arm64_aapcs_elf_gas.S</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#make-x86-64-sysv-elf-gas-S"><span class="nav-number">3.</span> <span class="nav-text">make_x86_64_sysv_elf_gas.S</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jump-x86-64-sysv-elf-gas-S"><span class="nav-number">4.</span> <span class="nav-text">jump_x86_64_sysv_elf_gas.S</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#x86-64%E6%9E%B6%E6%9E%84%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2"><span class="nav-number">5.</span> <span class="nav-text">x86_64 架构上下文切换</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="paopao"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">paopao</p>
  <div class="site-description" itemprop="description">Stay hungry, stay foolish.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">99</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
<!-- none-select-br -->

<p></p>

<!-- hitokoto -->

<div class="hitokoto-title">
	<i class="fa fa-paragraph"></i>
	<b>一言</b>
</div>

<div id="hitokoto">:D 获取中...</div>
<i id="hitofrom">:D 获取中...</i>

<script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
<script>
  fetch('https://v1.hitokoto.cn')
    .then(function (res){
      return res.json();
    })
    .then(function (data) {
      var hitokoto = document.getElementById('hitokoto');
      hitokoto.innerText = '\xa0\xa0\xa0\xa0\xa0\xa0\xa0' + data.hitokoto;
      var hitofrom = document.getElementById('hitofrom');
      hitofrom.innerText = "——" + data.from + '\xa0'; 
    })
    .catch(function (err) {
      console.error(err);
    })
</script>
        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liu-paopao.github.io/posts/4059c7aa.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="paopao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PaoPao's Blog">
      <meta itemprop="description" content="Stay hungry, stay foolish.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="boost 协程中 arm64 和 x86_64 架构汇编实现 | PaoPao's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          boost 协程中 arm64 和 x86_64 架构汇编实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-05 22:35:05" itemprop="dateCreated datePublished" datetime="2022-12-05T22:35:05+08:00">2022-12-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-12-23 10:36:15" itemprop="dateModified" datetime="2022-12-23T10:36:15+08:00">2022-12-23</time>
    </span>

  
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>boost 协程上下文切换 make_arm64_aapcs_elf_gas.S 和 jump_arm64_aapcs_elf_gas.S 以及 make_x86_64_aapcs_elf_gas.S 和 jump_x86_64_aapcs_elf_gas.S 汇编源码分析</p>
<span id="more"></span>

<p>源码目录：<code>boost-1.58.0\libs\context\src\asm</code></p>
<h2 id="make-arm64-aapcs-elf-gas-S"><a href="#make-arm64-aapcs-elf-gas-S" class="headerlink" title="make_arm64_aapcs_elf_gas.S"></a>make_arm64_aapcs_elf_gas.S</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">            Copyright Edward Nevill 2015</span><br><span class="line">   Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">      (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">          http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">*/</span><br><span class="line">/*******************************************************</span><br><span class="line"> *                                                     *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x0 | 0x4 | 0x8 | 0xc | 0x10| 0x14| 0x18| 0x1c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    d8     |    d9     |    d10    |    d11    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  8  |  9  |  10 |  11 |  12 |  13 |  14 |  15 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x20| 0x24| 0x28| 0x2c| 0x30| 0x34| 0x38| 0x3c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    d12    |    d13    |    d14    |    d15    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  16 |  17 |  18 |  19 |  20 |  21 |  22 |  23 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x40| 0x44| 0x48| 0x4c| 0x50| 0x54| 0x58| 0x5c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x19    |    x20    |    x21    |    x22    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  24 |  25 |  26 |  27 |  28 |  29 |  30 |  31 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x60| 0x64| 0x68| 0x6c| 0x70| 0x74| 0x78| 0x7c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x23    |    x24    |    x25    |    x26    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  32 |  33 |  34 |  35 |  36 |  37 |  38 |  39 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x80| 0x84| 0x88| 0x8c| 0x90| 0x94| 0x98| 0x9c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x27    |    x28    |    FP     |     LR    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  40 |  41 |  42 | 43  |           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0xa0| 0xa4| 0xa8| 0xac|           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |     PC    |   align   |           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *                                                     *</span><br><span class="line"> *******************************************************/</span><br><span class="line"></span><br><span class="line">.cpu    generic+fp+simd</span><br><span class="line">.text</span><br><span class="line">.align  2</span><br><span class="line">.global make_fcontext</span><br><span class="line">.type   make_fcontext, %function</span><br><span class="line">make_fcontext:</span><br><span class="line">    # shift address in x0 (allocated stack) to lower 16 byte boundary</span><br><span class="line">    and x0, x0, ~0xF</span><br><span class="line"></span><br><span class="line">    # reserve space for context-data on context-stack</span><br><span class="line">    sub  x0, x0, #0xb0</span><br><span class="line"></span><br><span class="line">    # third arg of make_fcontext() == address of context-function</span><br><span class="line">    # store address as a PC to jump in</span><br><span class="line">    str  x2, [x0, #0xa0]</span><br><span class="line"></span><br><span class="line">    # save address of finish as return-address for context-function</span><br><span class="line">    # will be entered after context-function returns (LR register)</span><br><span class="line">    adr  x1, finish</span><br><span class="line">    str  x1, [x0, #0x98]</span><br><span class="line"></span><br><span class="line">    ret  x30 // return pointer to context-data (x0)</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">    # exit code is zero</span><br><span class="line">    mov  x0, #0</span><br><span class="line">    # exit application</span><br><span class="line">    bl  _exit</span><br><span class="line"></span><br><span class="line">.size   make_fcontext,.-make_fcontext</span><br><span class="line"># Mark that we don't need executable stack.</span><br><span class="line">.section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>



<h2 id="jump-arm64-aapcs-elf-gas-S"><a href="#jump-arm64-aapcs-elf-gas-S" class="headerlink" title="jump_arm64_aapcs_elf_gas.S"></a>jump_arm64_aapcs_elf_gas.S</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">            Copyright Edward Nevill 2015</span><br><span class="line">   Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">      (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">          http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">*/</span><br><span class="line">/*******************************************************</span><br><span class="line"> *                                                     *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x0 | 0x4 | 0x8 | 0xc | 0x10| 0x14| 0x18| 0x1c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    d8     |    d9     |    d10    |    d11    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  8  |  9  |  10 |  11 |  12 |  13 |  14 |  15 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x20| 0x24| 0x28| 0x2c| 0x30| 0x34| 0x38| 0x3c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    d12    |    d13    |    d14    |    d15    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  16 |  17 |  18 |  19 |  20 |  21 |  22 |  23 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x40| 0x44| 0x48| 0x4c| 0x50| 0x54| 0x58| 0x5c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x19    |    x20    |    x21    |    x22    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  24 |  25 |  26 |  27 |  28 |  29 |  30 |  31 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x60| 0x64| 0x68| 0x6c| 0x70| 0x74| 0x78| 0x7c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x23    |    x24    |    x25    |    x26    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  32 |  33 |  34 |  35 |  36 |  37 |  38 |  39 |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0x80| 0x84| 0x88| 0x8c| 0x90| 0x94| 0x98| 0x9c|  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |    x27    |    x28    |    FP     |     LR    |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |  40 |  41 |  42 | 43  |           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  | 0xa0| 0xa4| 0xa8| 0xac|           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *  |     PC    |   align   |           |           |  *</span><br><span class="line"> *  -------------------------------------------------  *</span><br><span class="line"> *                                                     *</span><br><span class="line"> *******************************************************/</span><br><span class="line"></span><br><span class="line">.cpu    generic+fp+simd</span><br><span class="line">.text</span><br><span class="line">.align  2</span><br><span class="line">.global jump_fcontext</span><br><span class="line">.type   jump_fcontext, %function</span><br><span class="line">jump_fcontext:</span><br><span class="line">    # prepare stack for GP + FPU</span><br><span class="line">    sub  sp, sp, #0xb0</span><br><span class="line"></span><br><span class="line"># Because gcc may save integer registers in fp registers across a</span><br><span class="line"># function call we cannot skip saving the fp registers.</span><br><span class="line">#</span><br><span class="line"># Do not reinstate this test unless you fully understand what you</span><br><span class="line"># are doing.</span><br><span class="line">#</span><br><span class="line">#    # test if fpu env should be preserved</span><br><span class="line">#    cmp  w3, #0</span><br><span class="line">#    b.eq  1f</span><br><span class="line"></span><br><span class="line">    # save d8 - d15</span><br><span class="line">    stp  d8,  d9,  [sp, #0x00]</span><br><span class="line">    stp  d10, d11, [sp, #0x10]</span><br><span class="line">    stp  d12, d13, [sp, #0x20]</span><br><span class="line">    stp  d14, d15, [sp, #0x30]</span><br><span class="line"></span><br><span class="line">1:</span><br><span class="line">    # save x19-x30</span><br><span class="line">    stp  x19, x20, [sp, #0x40]</span><br><span class="line">    stp  x21, x22, [sp, #0x50]</span><br><span class="line">    stp  x23, x24, [sp, #0x60]</span><br><span class="line">    stp  x25, x26, [sp, #0x70]</span><br><span class="line">    stp  x27, x28, [sp, #0x80]</span><br><span class="line">    stp  x29, x30, [sp, #0x90]</span><br><span class="line"></span><br><span class="line">    # save LR as PC</span><br><span class="line">    str  x30, [sp, #0xa0]</span><br><span class="line"></span><br><span class="line">    # store RSP (pointing to context-data) in first argument (x0).</span><br><span class="line">    # STR cannot have sp as a target register</span><br><span class="line">    mov  x4, sp</span><br><span class="line">    str  x4, [x0]</span><br><span class="line"></span><br><span class="line">    # restore RSP (pointing to context-data) from A2 (x1)</span><br><span class="line">    mov  sp, x1</span><br><span class="line"></span><br><span class="line">#    # test if fpu env should be preserved</span><br><span class="line">#    cmp  w3, #0</span><br><span class="line">#    b.eq  2f</span><br><span class="line"></span><br><span class="line">    # load d8 - d15</span><br><span class="line">    ldp  d8,  d9,  [sp, #0x00]</span><br><span class="line">    ldp  d10, d11, [sp, #0x10]</span><br><span class="line">    ldp  d12, d13, [sp, #0x20]</span><br><span class="line">    ldp  d14, d15, [sp, #0x30]</span><br><span class="line"></span><br><span class="line">2:</span><br><span class="line">    # load x19-x30</span><br><span class="line">    ldp  x19, x20, [sp, #0x40]</span><br><span class="line">    ldp  x21, x22, [sp, #0x50]</span><br><span class="line">    ldp  x23, x24, [sp, #0x60]</span><br><span class="line">    ldp  x25, x26, [sp, #0x70]</span><br><span class="line">    ldp  x27, x28, [sp, #0x80]</span><br><span class="line">    ldp  x29, x30, [sp, #0x90]</span><br><span class="line"></span><br><span class="line">    # use third arg as return value after jump</span><br><span class="line">    # and as first arg in context function</span><br><span class="line">    mov  x0, x2</span><br><span class="line"></span><br><span class="line">    # load pc</span><br><span class="line">    ldr  x4, [sp, #0xa0]</span><br><span class="line"></span><br><span class="line">    # restore stack from GP + FPU</span><br><span class="line">    add  sp, sp, #0xb0</span><br><span class="line"></span><br><span class="line">    ret x4</span><br><span class="line">.size   jump_fcontext,.-jump_fcontext</span><br><span class="line"># Mark that we don't need executable stack.</span><br><span class="line">.section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>

<h2 id="make-x86-64-sysv-elf-gas-S"><a href="#make-x86-64-sysv-elf-gas-S" class="headerlink" title="make_x86_64_sysv_elf_gas.S"></a>make_x86_64_sysv_elf_gas.S</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">            Copyright Oliver Kowalke 2009.</span><br><span class="line">   Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">      (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">            http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/****************************************************************************************</span><br><span class="line"> *                                                                                      *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    0    |    1    |    2    |    3    |    4     |    5    |    6    |    7    |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x0   |   0x4   |   0x8   |   0xc   |   0x10   |   0x14  |   0x18  |   0x1c  |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  | fc_mxcsr|fc_x87_cw|        R12        |         R13        |        R14        |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    8    |    9    |   10    |   11    |    12    |    13   |    14   |    15   |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x20  |   0x24  |   0x28  |  0x2c   |   0x30   |   0x34  |   0x38  |   0x3c  |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |        R15        |        RBX        |         RBP        |        RIP        |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    16   |   17    |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x40  |   0x44  |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |        EXIT       |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *                                                                                      *</span><br><span class="line"> ****************************************************************************************/</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">.globl make_fcontext</span><br><span class="line">.type make_fcontext,@function</span><br><span class="line">.align 16</span><br><span class="line">make_fcontext:</span><br><span class="line">    /* first arg of make_fcontext() == top of context-stack */</span><br><span class="line">    movq  %rdi, %rax</span><br><span class="line"></span><br><span class="line">    /* shift address in RAX to lower 16 byte boundary */</span><br><span class="line">    andq  $-16, %rax</span><br><span class="line"></span><br><span class="line">    /* reserve space for context-data on context-stack */</span><br><span class="line">    /* size for fc_mxcsr .. RIP + return-address for context-function */</span><br><span class="line">    /* on context-function entry: (RSP -0x8) % 16 == 0 */</span><br><span class="line">    leaq  -0x48(%rax), %rax</span><br><span class="line"></span><br><span class="line">    /* third arg of make_fcontext() == address of context-function */</span><br><span class="line">    movq  %rdx, 0x38(%rax)</span><br><span class="line"></span><br><span class="line">    /* save MMX control- and status-word */</span><br><span class="line">    stmxcsr  (%rax)</span><br><span class="line">    /* save x87 control-word */</span><br><span class="line">    fnstcw   0x4(%rax)</span><br><span class="line"></span><br><span class="line">    /* compute abs address of label finish */</span><br><span class="line">    leaq  finish(%rip), %rcx</span><br><span class="line">    /* save address of finish as return-address for context-function */</span><br><span class="line">    /* will be entered after context-function returns */</span><br><span class="line">    movq  %rcx, 0x40(%rax)</span><br><span class="line"></span><br><span class="line">    ret /* return pointer to context-data */</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">    /* exit code is zero */</span><br><span class="line">    xorq  %rdi, %rdi</span><br><span class="line">    /* exit application */</span><br><span class="line">    call  _exit@PLT</span><br><span class="line">    hlt</span><br><span class="line">.size make_fcontext,.-make_fcontext</span><br><span class="line"></span><br><span class="line">/* Mark that we don't need executable stack. */</span><br><span class="line">.section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>


<h2 id="jump-x86-64-sysv-elf-gas-S"><a href="#jump-x86-64-sysv-elf-gas-S" class="headerlink" title="jump_x86_64_sysv_elf_gas.S"></a>jump_x86_64_sysv_elf_gas.S</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">            Copyright Oliver Kowalke 2009.</span><br><span class="line">   Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">      (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">            http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">/****************************************************************************************</span><br><span class="line"> *                                                                                      *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    0    |    1    |    2    |    3    |    4     |    5    |    6    |    7    |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x0   |   0x4   |   0x8   |   0xc   |   0x10   |   0x14  |   0x18  |   0x1c  |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  | fc_mxcsr|fc_x87_cw|        R12        |         R13        |        R14        |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    8    |    9    |   10    |   11    |    12    |    13   |    14   |    15   |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x20  |   0x24  |   0x28  |  0x2c   |   0x30   |   0x34  |   0x38  |   0x3c  |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |        R15        |        RBX        |         RBP        |        RIP        |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |    16   |   17    |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |   0x40  |   0x44  |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *  |        EXIT       |                                                            |  *</span><br><span class="line"> *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> *                                                                                      *</span><br><span class="line"> ****************************************************************************************/</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">.globl jump_fcontext</span><br><span class="line">.type jump_fcontext,@function</span><br><span class="line">.align 16</span><br><span class="line">jump_fcontext:</span><br><span class="line">    pushq  %rbp  /* save RBP */</span><br><span class="line">    pushq  %rbx  /* save RBX */</span><br><span class="line">    pushq  %r15  /* save R15 */</span><br><span class="line">    pushq  %r14  /* save R14 */</span><br><span class="line">    pushq  %r13  /* save R13 */</span><br><span class="line">    pushq  %r12  /* save R12 */</span><br><span class="line"></span><br><span class="line">    /* prepare stack for FPU */</span><br><span class="line">    leaq  -0x8(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">    /* test for flag preserve_fpu */</span><br><span class="line">    cmp  $0, %rcx</span><br><span class="line">    je  1f</span><br><span class="line"></span><br><span class="line">    /* save MMX control- and status-word */</span><br><span class="line">    stmxcsr  (%rsp)</span><br><span class="line">    /* save x87 control-word */</span><br><span class="line">    fnstcw   0x4(%rsp)</span><br><span class="line"></span><br><span class="line">1:</span><br><span class="line">    /* store RSP (pointing to context-data) in RDI */</span><br><span class="line">    movq  %rsp, (%rdi)</span><br><span class="line"></span><br><span class="line">    /* restore RSP (pointing to context-data) from RSI */</span><br><span class="line">    movq  %rsi, %rsp</span><br><span class="line"></span><br><span class="line">    /* test for flag preserve_fpu */</span><br><span class="line">    cmp  $0, %rcx</span><br><span class="line">    je  2f</span><br><span class="line"></span><br><span class="line">    /* restore MMX control- and status-word */</span><br><span class="line">    ldmxcsr  (%rsp)</span><br><span class="line">    /* restore x87 control-word */</span><br><span class="line">    fldcw  0x4(%rsp)</span><br><span class="line"></span><br><span class="line">2:</span><br><span class="line">    /* prepare stack for FPU */</span><br><span class="line">    leaq  0x8(%rsp), %rsp</span><br><span class="line"></span><br><span class="line">    popq  %r12  /* restrore R12 */</span><br><span class="line">    popq  %r13  /* restrore R13 */</span><br><span class="line">    popq  %r14  /* restrore R14 */</span><br><span class="line">    popq  %r15  /* restrore R15 */</span><br><span class="line">    popq  %rbx  /* restrore RBX */</span><br><span class="line">    popq  %rbp  /* restrore RBP */</span><br><span class="line"></span><br><span class="line">    /* restore return-address */</span><br><span class="line">    popq  %r8</span><br><span class="line"></span><br><span class="line">    /* use third arg as return-value after jump */</span><br><span class="line">    movq  %rdx, %rax</span><br><span class="line">    /* use third arg as first arg in context function */</span><br><span class="line">    movq  %rdx, %rdi</span><br><span class="line"></span><br><span class="line">    /* indirect jump to context */</span><br><span class="line">    jmp  *%r8</span><br><span class="line">.size jump_fcontext,.-jump_fcontext</span><br><span class="line"></span><br><span class="line">/* Mark that we don't need executable stack.  */</span><br><span class="line">.section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>

<h2 id="x86-64架构上下文切换"><a href="#x86-64架构上下文切换" class="headerlink" title="x86_64架构上下文切换"></a>x86_64 架构上下文切换</h2><p>实现协程最核心的部分就是栈切换了，其他的和非阻塞 io 的编程方式没什么区别。</p>
<p>栈切换，libc 中有一个实现，swapcontext，但是已经被标准移除了，未来是否可用不得而知，自己实现需要写汇编代码，这是一个很困难的任务，因为既要熟悉不同 cpu 指令集又要熟悉不同平台的标准，好在从 boost library 的协程实现中找到了已经写好了的栈切换汇编代码，利用这些汇编代码可以在 c 语言中实现栈切换。</p>
<p>这段代码是在 s_task 协程库中发现的，s_task 很好，还可以和 libuv 结合，如果没有特殊要求，可以直接使用了，但是如果想根据自己工作中的业务逻辑做定制，还是需要掌握原理，并且不清楚原理，可能不能用最恰当的方式使用，实现最好的设计，出了问题也不知道该怎么查和用什么办法查。</p>
<p>附上 s_task 和 boost library 的地址，感兴趣的可以去研究一下。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/xhawk18/s_task">https://github.com/xhawk18/s_task</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/boostorg/context">https://github.com/boostorg/context</a></p>
<p>栈切换代码在源码的 asm 目录中，实际上在 c 语言中对应两个函数，</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef void* fcontext_t;</span><br><span class="line">typedef struct {</span><br><span class="line">    fcontext_t  fctx;</span><br><span class="line">    void* data;</span><br><span class="line">} transfer_t;</span><br><span class="line"></span><br><span class="line">extern transfer_t jump_fcontext( fcontext_t const to, void * vp);</span><br><span class="line">extern fcontext_t make_fcontext( void * sp, size_t size, void (* fn)( transfer_t) );</span><br></pre></td></tr></tbody></table></figure>

<p><a href="javascript:void(0);"><img src="https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212231034473.gif" alt="复制代码"></a></p>
<p>这两个函数是什么意思，怎么用，看了 s_task 中的代码，但是开始的时候还是没看懂，于是想从汇编的角度入手，最终通过 x86_64 的汇编代码 (make_x86_64_sysv_elf_gas.S jump_x86_64_sysv_elf_gas.S) 弄清楚了这两个函数的用法，结论在本文最末尾，如果只想看结果，可以跳到最后面。</p>
<p>直接看代码注释吧。</p>
<p>make_x86_64_sysv_elf_gas.S</p>
<p><a href="javascript:void(0);"><img src="https://cdn.jsdelivr.net/gh/HanxuLiu/CDN1/img/2022/202212231034473.gif" alt="复制代码"></a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">  1 /*</span><br><span class="line">  2             Copyright Oliver Kowalke 2009.</span><br><span class="line">  3    Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">  4       (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">  5             http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">  6 */</span><br><span class="line">  7 </span><br><span class="line">  8 // 栈空间图，栈顶在低地址，注意和jump_x86_64_sysv_elf_gas.S对比着看，里面代表的是内存(栈，运行现场)中的数据</span><br><span class="line">  9 // 不代表寄存器，途中标的寄存器的意思是这些寄存器在保存现场的时候会保存到对应的内存地址中</span><br><span class="line"> 10 /****************************************************************************************</span><br><span class="line"> 11  *                                                                                      *</span><br><span class="line"> 12  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 13  *  |    0    |    1    |    2    |    3    |    4     |    5    |    6    |    7    |  *</span><br><span class="line"> 14  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 15  *  |   0x0   |   0x4   |   0x8   |   0xc   |   0x10   |   0x14  |   0x18  |   0x1c  |  *</span><br><span class="line"> 16  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 17  *  | fc_mxcsr|fc_x87_cw|        R12        |         R13        |        R14        |  *</span><br><span class="line"> 18  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 19  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 20  *  |    8    |    9    |   10    |   11    |    12    |    13   |    14   |    15   |  *</span><br><span class="line"> 21  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 22  *  |   0x20  |   0x24  |   0x28  |  0x2c   |   0x30   |   0x34  |   0x38  |   0x3c  |  *</span><br><span class="line"> 23  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 24  *  |        R15        |        RBX        |         RBP        |        RIP        |  *</span><br><span class="line"> 25  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 26  *                                                                                      *</span><br><span class="line"> 27  ****************************************************************************************/</span><br><span class="line"> 28 </span><br><span class="line"> 29 .file "make_x86_64_sysv_elf_gas.S"</span><br><span class="line"> 30 .text</span><br><span class="line"> 31 .globl make_fcontext</span><br><span class="line"> 32 .type make_fcontext,@function</span><br><span class="line"> 33 .align 16</span><br><span class="line"> 34 make_fcontext:</span><br><span class="line"> 35 // make_fcontext的第一个参数保存到rax中，rax现在开始代表了这个运行环境的栈顶，</span><br><span class="line"> 36 // rax也是本函数的返回值，</span><br><span class="line"> 37     /* first arg of make_fcontext() == top of context-stack */</span><br><span class="line"> 38     movq  %rdi, %rax</span><br><span class="line"> 39 </span><br><span class="line"> 40 // 16对齐, 规定的</span><br><span class="line"> 41     /* shift address in RAX to lower 16 byte boundary */</span><br><span class="line"> 42     andq  $-16, %rax</span><br><span class="line"> 43 </span><br><span class="line"> 44 // -0x40就是将栈顶指针(栈顶寄存器，这里不是rsp，是rax，rsp是当前运行环境使用的)移动到图中的0位置，即分配栈空间</span><br><span class="line"> 45 // 递减栈是向下分配的</span><br><span class="line"> 46     /* reserve space for context-data on context-stack */</span><br><span class="line"> 47     /* on context-function entry: (RSP -0x8) % 16 == 0 */</span><br><span class="line"> 48     leaq  -0x40(%rax), %rax</span><br><span class="line"> 49 </span><br><span class="line"> 50 // size那个参数这里没有使用，第三个参数是fn，要执行的函数</span><br><span class="line"> 51 // 这里把fn的地址放到了0x28的位置，恢复到寄存器就是rbx</span><br><span class="line"> 52     /* third arg of make_fcontext() == address of context-function */</span><br><span class="line"> 53     /* stored in RBX */</span><br><span class="line"> 54     movq  %rdx, 0x28(%rax)</span><br><span class="line"> 55 </span><br><span class="line"> 56 // 这两个寄存器不清楚</span><br><span class="line"> 57     /* save MMX control- and status-word */</span><br><span class="line"> 58     stmxcsr  (%rax)</span><br><span class="line"> 59     /* save x87 control-word */</span><br><span class="line"> 60     fnstcw   0x4(%rax)</span><br><span class="line"> 61 </span><br><span class="line"> 62 // 从英文注释看，实现的是将trampoline的地址保存在0x38的位置，即rip保存的地方，返回之后接着运行的地址</span><br><span class="line"> 63 // 所以这个地方实际上是设置了跳转过来之后执行的指令的位置，jump_fcontext认为自己跳到了</span><br><span class="line"> 64 // 一个暂停过的地方，即保存过现场的地方，恢复现场继续执行，而这里是首次运行，所以要模拟这种场景</span><br><span class="line"> 65 // 也就是说启动一个任务之后会先运行trampoline那里。</span><br><span class="line"> 66     /* compute abs address of label trampoline */</span><br><span class="line"> 67     leaq  trampoline(%rip), %rcx</span><br><span class="line"> 68     /* save address of trampoline as return-address for context-function */</span><br><span class="line"> 69     /* will be entered after calling jump_fcontext() first time */</span><br><span class="line"> 70     movq  %rcx, 0x38(%rax)</span><br><span class="line"> 71 </span><br><span class="line"> 72 // 这里是把finish处的地址放到0x30中， 是一个技巧，见trampoline处</span><br><span class="line"> 73     /* compute abs address of label finish */</span><br><span class="line"> 74     leaq  finish(%rip), %rcx</span><br><span class="line"> 75     /* save address of finish as return-address for context-function */</span><br><span class="line"> 76     /* will be entered after context-function returns */</span><br><span class="line"> 77     movq  %rcx, 0x30(%rax)</span><br><span class="line"> 78 </span><br><span class="line"> 79 // make_fcontext函数返回</span><br><span class="line"> 80     ret /* return pointer to context-data */</span><br><span class="line"> 81 </span><br><span class="line"> 82 trampoline:</span><br><span class="line"> 83     /* store return address on stack */</span><br><span class="line"> 84     /* fix stack alignment */</span><br><span class="line"> 85     // 从jump_x86_64_sysv_elf_gas.S中可以看出，跳到这里之前已经从栈空间中恢复了rbp，也就是说</span><br><span class="line"> 86     // 现在rbp保存的是finish的地址，因为rbp是从0x30恢复的，0x30前面已经保存了finish的地址</span><br><span class="line"> 87     // 现在的栈顶rsp呢，是在图中0x40的位置，见jump_x86_64_sysv_elf_gas.S中的  leaq  0x40(%rsp), %rsp</span><br><span class="line"> 88     // 现在push rbp是把fish的地址push到了0x38的位置，也就是本应该保存返回地址rip的地方，</span><br><span class="line"> 89     // 也就是说fn运行结束返回到make_fcontext的finish处继续运行，就好像是make_fcontext调用</span><br><span class="line"> 90     // 的fn一样，当然只是好像而已。可见fn返回了整个进程就退出了，这是make_fcontext指定的。</span><br><span class="line"> 91     push %rbp</span><br><span class="line"> 92 </span><br><span class="line"> 93     // rbx是设置的fn的地址，跳到fn运行，首次运行fn任务才会走到这里，中间暂停了</span><br><span class="line"> 94     // 是恢复从暂停的地方的下一个指令开始执行。</span><br><span class="line"> 95     /* jump to context-function */</span><br><span class="line"> 96     jmp *%rbx</span><br><span class="line"> 97 </span><br><span class="line"> 98 finish:</span><br><span class="line"> 99 // 这里的代码就是退出进程了</span><br><span class="line">100     /* exit code is zero */</span><br><span class="line">101     xorq  %rdi, %rdi</span><br><span class="line">102     /* exit application */</span><br><span class="line">103     call  _exit@PLT</span><br><span class="line">104     hlt</span><br><span class="line">105 .size make_fcontext,.-make_fcontext</span><br><span class="line">106 </span><br><span class="line">107 /* Mark that we don't need executable stack. */</span><br><span class="line">108 .section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>


<p>jump_x86_64_sysv_elf_gas.S</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">  1 /*</span><br><span class="line">  2             Copyright Oliver Kowalke 2009.</span><br><span class="line">  3    Distributed under the Boost Software License, Version 1.0.</span><br><span class="line">  4       (See accompanying file LICENSE_1_0.txt or copy at</span><br><span class="line">  5             http://www.boost.org/LICENSE_1_0.txt)</span><br><span class="line">  6 */</span><br><span class="line">  7 </span><br><span class="line">  8 // 栈空间图，栈顶在低地址，注意和make_x86_64_sysv_elf_gas.S对比着看，里面代表的是内存(栈，运行现场)中的数据</span><br><span class="line">  9 // 不代表寄存器，途中标的寄存器的意思是这些寄存器在保存现场的时候会保存到对应的内存地址中</span><br><span class="line"> 10 /****************************************************************************************</span><br><span class="line"> 11  *                                                                                      *</span><br><span class="line"> 12  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 13  *  |    0    |    1    |    2    |    3    |    4     |    5    |    6    |    7    |  *</span><br><span class="line"> 14  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 15  *  |   0x0   |   0x4   |   0x8   |   0xc   |   0x10   |   0x14  |   0x18  |   0x1c  |  *</span><br><span class="line"> 16  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 17  *  | fc_mxcsr|fc_x87_cw|        R12        |         R13        |        R14        |  *</span><br><span class="line"> 18  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 19  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 20  *  |    8    |    9    |   10    |   11    |    12    |    13   |    14   |    15   |  *</span><br><span class="line"> 21  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 22  *  |   0x20  |   0x24  |   0x28  |  0x2c   |   0x30   |   0x34  |   0x38  |   0x3c  |  *</span><br><span class="line"> 23  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 24  *  |        R15        |        RBX        |         RBP        |        RIP        |  *</span><br><span class="line"> 25  *  ----------------------------------------------------------------------------------  *</span><br><span class="line"> 26  *                                                                                      *</span><br><span class="line"> 27  ****************************************************************************************/</span><br><span class="line"> 28 </span><br><span class="line"> 29 .file "jump_x86_64_sysv_elf_gas.S"</span><br><span class="line"> 30 .text</span><br><span class="line"> 31 .globl jump_fcontext</span><br><span class="line"> 32 .type jump_fcontext,@function</span><br><span class="line"> 33 .align 16</span><br><span class="line"> 34 jump_fcontext:</span><br><span class="line"> 35 // 保存当前的运行现场，caller-saved registers调用者保存，这里只保存callee-saved registers</span><br><span class="line"> 36     leaq  -0x38(%rsp), %rsp /* prepare stack */</span><br><span class="line"> 37 </span><br><span class="line"> 38 #if !defined(BOOST_USE_TSX)</span><br><span class="line"> 39     stmxcsr  (%rsp)     /* save MMX control- and status-word */</span><br><span class="line"> 40     fnstcw   0x4(%rsp)  /* save x87 control-word */</span><br><span class="line"> 41 #endif</span><br><span class="line"> 42 </span><br><span class="line"> 43     movq  %r12, 0x8(%rsp)  /* save R12 */</span><br><span class="line"> 44     movq  %r13, 0x10(%rsp)  /* save R13 */</span><br><span class="line"> 45     movq  %r14, 0x18(%rsp)  /* save R14 */</span><br><span class="line"> 46     movq  %r15, 0x20(%rsp)  /* save R15 */</span><br><span class="line"> 47     movq  %rbx, 0x28(%rsp)  /* save RBX */</span><br><span class="line"> 48     movq  %rbp, 0x30(%rsp)  /* save RBP */</span><br><span class="line"> 49     // 这里为什么没有使用0x38位置的8个字节，因为这里面存的是返回地址，即本函数返回的时候</span><br><span class="line"> 50     // 要继续运行的指令的地址，在调用jump_fcontext的时候已经保存了，所以这里不用保存</span><br><span class="line"> 51     // 看make_fcontext可以看到，那里使用了0x38，因为那个fcontext不是通过调用jump_fcontext</span><br><span class="line"> 52     // 生成的，而是人为制造的。</span><br><span class="line"> 53     //</span><br><span class="line"> 54 // 保存现场完毕</span><br><span class="line"> 55 </span><br><span class="line"> 56 // 函数的调用者会在被调用函数退出的时候读取rax作为返回值</span><br><span class="line"> 57 // transfer_t需要两个寄存器保存，另一个是rdx</span><br><span class="line"> 58 // 但注意这里的返回值不是本次jump_fcontext调用的返回值，</span><br><span class="line"> 59 // 而是另一个栈空间的jump_fcontext，本次调用是不返回的，</span><br><span class="line"> 60 // 实际上所有的jump_fcontext都是不返回的，都是别的地方</span><br><span class="line"> 61 // 跳过去，看起来好像是它返回</span><br><span class="line"> 62 //</span><br><span class="line"> 63 // 函数调用就好比是一维世界，从哪里进，再从哪里出，而jump_fcontext好比是二维的世界，</span><br><span class="line"> 64 // 从“天上”跑了，再从“天上”掉下来。</span><br><span class="line"> 65     /* store RSP (pointing to context-data) in RAX */</span><br><span class="line"> 66     movq  %rsp, %rax</span><br><span class="line"> 67 </span><br><span class="line"> 68 // 把jump_fcontext第一个参数给rsp，第一个参数即运行上下文，别的地方</span><br><span class="line"> 69 // 保存现场或make_fcontext生成的栈顶地址，这里放到</span><br><span class="line"> 70 // rsp中，即完成了栈空间的切换，下条命令开始就是在另一个</span><br><span class="line"> 71 // 栈空间运行了，已经跳走完成， 跳之前做了什么呢，保存现场</span><br><span class="line"> 72 // 并且把现场放到rax中，跳过去之后的返回值会返回跳之前的现场</span><br><span class="line"> 73     /* restore RSP (pointing to context-data) from RDI */</span><br><span class="line"> 74     movq  %rdi, %rsp</span><br><span class="line"> 75 </span><br><span class="line"> 76 // 这里开始是一个新的栈空间了，也就是一个新的任务</span><br><span class="line"> 77 // 分两种情况，</span><br><span class="line"> 78 // 1. 如果是恢复一个任务的运行，那么rsp是它调用jump_fcontext切换走</span><br><span class="line"> 79 //    的时候的现场,现在开始恢复，这时0x38位置是返回地址，也就是这个</span><br><span class="line"> 80 //    任务在上一次调用jump_fcontext(暂停，切换到其他任务)的时候保存</span><br><span class="line"> 81 //    的调用jump_fcontext后面的那个指令对应的地址，即从暂停的位置</span><br><span class="line"> 82 //    继续执行。</span><br><span class="line"> 83 // 2. 如果是新制造出来的任务，0x38保存的是make_fcontext中的trampoline</span><br><span class="line"> 84 //    也就是会跳到那里执行。</span><br><span class="line"> 85 //</span><br><span class="line"> 86 //  目前只是放到了r8中，还没有开始执行，后面的过程是继续恢复现场。</span><br><span class="line"> 87     movq  0x38(%rsp), %r8  /* restore return-address */</span><br><span class="line"> 88 </span><br><span class="line"> 89 #if !defined(BOOST_USE_TSX)</span><br><span class="line"> 90     ldmxcsr  (%rsp)     /* restore MMX control- and status-word */</span><br><span class="line"> 91     fldcw    0x4(%rsp)  /* restore x87 control-word */</span><br><span class="line"> 92 #endif</span><br><span class="line"> 93 </span><br><span class="line"> 94 // 保存和恢复的过程是对称的，正是栈的特点</span><br><span class="line"> 95     movq  0x8(%rsp), %r12  /* restore R12 */</span><br><span class="line"> 96     movq  0x10(%rsp), %r13  /* restore R13 */</span><br><span class="line"> 97     movq  0x18(%rsp), %r14  /* restore R14 */</span><br><span class="line"> 98     movq  0x20(%rsp), %r15  /* restore R15 */</span><br><span class="line"> 99     movq  0x28(%rsp), %rbx  /* restore RBX */</span><br><span class="line">100     movq  0x30(%rsp), %rbp  /* restore RBP */</span><br><span class="line">101 </span><br><span class="line">102 // 恢复另一个任务保存现场之前的rsp(栈顶)</span><br><span class="line">103     leaq  0x40(%rsp), %rsp /* prepare stack */</span><br><span class="line">104 </span><br><span class="line">105 // 这里面有条件编译，似乎是和32位和64位相关，这里按照上面的分支来分析</span><br><span class="line">106     /* return transfer_t from jump */</span><br><span class="line">107 #if !defined(_ILP32)</span><br><span class="line">108     /* RAX == fctx, RDX == data */</span><br><span class="line">109     // rsi是jump_fcontext的第二个参数vp，这里赋值给rdx，rax rdx</span><br><span class="line">110     // 里面存储的是返回值transfer_t的内容，rax是前面我们保存现场</span><br><span class="line">111     // 获得的，也就是说是切换之前的现场，rdx呢，也是切换之前传的，</span><br><span class="line">112     // 也就是说切换之后返回的内容都是切换之前的信息。</span><br><span class="line">113     // 一般网上查到的都是说rax是返回值，但是这里返回结构体，里面</span><br><span class="line">114     // 是两个8字节，到底是怎么传递的很少有地方说，我也是网上查到的</span><br><span class="line">115     // 这种情况是用两个寄存器保存的，rdx也会用来保存返回值，有一个文档可以参考</span><br><span class="line">116     // System V Application Binary Interface AMD64 Architecture Processor Supplement</span><br><span class="line">117     movq  %rsi, %rdx</span><br><span class="line">118 #else</span><br><span class="line">119     /* RAX == data:fctx */</span><br><span class="line">120     salq  $32, %rsi</span><br><span class="line">121     orq   %rsi, %rax</span><br><span class="line">122 #endif</span><br><span class="line">123     /* pass transfer_t as first arg in context function */</span><br><span class="line">124 #if !defined(_ILP32)</span><br><span class="line">125     /* RDI == fctx, RSI == data */</span><br><span class="line">126 #else</span><br><span class="line">127     /* RDI == data:fctx */</span><br><span class="line">128 #endif</span><br><span class="line">129 </span><br><span class="line">130     // rdi是函数调用的第一个参数，rsi是第二个参数</span><br><span class="line">131     // 这里把rax放到rdi中，是为了把切换之前保存的现场作为第一个参数传给要执行的函数</span><br><span class="line">132     // 这是给第一次运行准备的，fn的参数transfer_t的两个成员，一个是rdi，一个是rsi</span><br><span class="line">133     // rsi就是切换之前调用的(即本次调用)那个jump_fcontext传递的第二个参数vp</span><br><span class="line">134     //</span><br><span class="line">135     // 如果不是第一次调用呢，会不会有影响，不会，rdi是caller-saved register，调用者</span><br><span class="line">136     // 负责保存，如果即将切换到的那个任务的对应的函数需要rdi的值，它会自己保存的，</span><br><span class="line">137     // 从jump_fcontext出来之后它会自己恢复，对它来讲就是调用了jump_fcontext这个函数，</span><br><span class="line">138     // 然后过了一段时间返回了，中间的过程完全不知情。 天上走了，又从天上回来。</span><br><span class="line">139     movq  %rax, %rdi</span><br><span class="line">140 </span><br><span class="line">141 //  前面提到了将返回地址放到r8中，现在跳过去开始执行了</span><br><span class="line">142     /* indirect jump to context */</span><br><span class="line">143     jmp  *%r8</span><br><span class="line">144 .size jump_fcontext,.-jump_fcontext</span><br><span class="line">145 </span><br><span class="line">146 /* Mark that we don't need executable stack.  */</span><br><span class="line">147 .section .note.GNU-stack,"",%progbits</span><br></pre></td></tr></tbody></table></figure>


<p>简单测试一下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"> 1 #include &lt;stdio.h&gt;</span><br><span class="line"> 2 </span><br><span class="line"> 3 char stack0[10240];//一个printf会占用1千多字节的栈空间!!!!!</span><br><span class="line"> 4 char stack1[10240];</span><br><span class="line"> 5 </span><br><span class="line"> 6 typedef void* fcontext_t;</span><br><span class="line"> 7 typedef struct {</span><br><span class="line"> 8     fcontext_t  fctx;</span><br><span class="line"> 9     void* data;</span><br><span class="line">10 } transfer_t;</span><br><span class="line">11 </span><br><span class="line">12 extern transfer_t jump_fcontext(fcontext_t const to, void * vp);</span><br><span class="line">13 extern fcontext_t make_fcontext(void * sp, size_t size, void (* fn)( transfer_t));</span><br><span class="line">14 </span><br><span class="line">15 fcontext_t fcmain, fc0, fc1;</span><br><span class="line">16 </span><br><span class="line">17 void fn0(transfer_t t){</span><br><span class="line">18     printf("%s %d\n", __func__, __LINE__);</span><br><span class="line">19 </span><br><span class="line">20     fcontext_t *p = t.data;</span><br><span class="line">21     *p = t.fctx;</span><br><span class="line">22 </span><br><span class="line">23     // 切换fn1</span><br><span class="line">24     transfer_t ret = jump_fcontext(fc1, &amp;fc0);</span><br><span class="line">25     p = ret.data;</span><br><span class="line">26     *p = ret.fctx;</span><br><span class="line">27     printf("%s %d\n", __func__, __LINE__);</span><br><span class="line">28     // 切换main</span><br><span class="line">29     jump_fcontext(fcmain, &amp;fc0);</span><br><span class="line">30     printf("never back\n");</span><br><span class="line">31 }</span><br><span class="line">32 </span><br><span class="line">33 void fn1(transfer_t t){</span><br><span class="line">34     printf("%p\n", t.fctx);</span><br><span class="line">35     printf("%s %d\n", __func__, __LINE__);</span><br><span class="line">36     fcontext_t *p = t.data;</span><br><span class="line">37     *p = t.fctx;</span><br><span class="line">38     // 切换fn0</span><br><span class="line">39     jump_fcontext(fc0, &amp;fc1);</span><br><span class="line">40     printf("never back\n");</span><br><span class="line">41 }</span><br><span class="line">42 </span><br><span class="line">43 int main(int argc, char **argv) {</span><br><span class="line">44 </span><br><span class="line">45     fc0 = make_fcontext(stack0 + sizeof stack0, sizeof stack0, fn0);</span><br><span class="line">46     fc1 = make_fcontext(stack1 + sizeof stack1, sizeof stack1, fn1);</span><br><span class="line">47 </span><br><span class="line">48     printf("%s %d\n", __func__, __LINE__);</span><br><span class="line">49     // 切换fn0</span><br><span class="line">50     jump_fcontext(fc0, &amp;fcmain);</span><br><span class="line">51     printf("%s %d\n", __func__, __LINE__);</span><br><span class="line">52 </span><br><span class="line">53     return 0;</span><br><span class="line">54 }</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> % gcc -O t.c asm/make_gas.S asm/jump_gas.S</span><br><span class="line"> % ./a.out</span><br><span class="line">main 48</span><br><span class="line">fn0 18</span><br><span class="line">0x5591d8183800</span><br><span class="line">fn1 35</span><br><span class="line">fn0 27</span><br><span class="line">main 51</span><br></pre></td></tr></tbody></table></figure>

<p>结论：</p>
<p>make_fcontext 中的 sp 是栈顶指针，size 是栈空间的大小，虽然 cpu 可能支持两种方向，但目前我还没有听过栈方向递增的系统，如果是递减栈，应该把栈顶指针设置成最高地址，比如申请了一段内存作为函数栈，大小 1024，地址在 void *p 中，那么应该这样用</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make_fcontext(p+1024, 1024, fn);</span><br></pre></td></tr></tbody></table></figure>

<p>fn 是协程任务启动的时候运行的函数，和线程创建的时候指定的函数类似。make_fcontext 的返回值就是一个运行 (栈空间) 上下文，它将被用于 jump_context 中的 to 参数，这样可以启动这个任务。启动任务之后调用 fn，fn 是 jump_context 中调用的，函数参数传递的实际上是两部分，第一部分，fcontext_t 类型，是栈切换之前的运行上下文，第二个参数是</p>
<p>jump_fcontext 中传递的 vp 参数。jump_fcontext 的返回值也分为两部分，第一部分是栈切换之前的运行上下文，第二部分是传递的参数 vp（<strong>这个 vp 不是本任务 jump_fcontext 调用的 vp</strong>，而是其他任务切换到本任务的时候调用 jump_fcontext 传递的 vp），这是因为 jump_fcontext 不是普通的函数，普通的函数在一个栈空间上执行，而 jump_fcontext 是跨越栈空间的，函数调用前，要保存现场，然后再恢复，jump_fcontext 也要保存现场，但是恢复并不是在这个函数<strong>调用</strong>中恢复的，这个调用已经一去不复返了，只负责跳走，不负责回来，甚至可能永远也回不来了，与其说它回来了，不如说是别的地方跳过来了，jump_fcontext “返回” 的就是跳过来的那个人的信息，它的运行上下文 (保存着它的运行现场，cpu 寄存器，栈空间)，还有它调用 jump_fcontext 跳过来时传递的参数 vp。</p>
<p>一个任务只要执行，它的运行上下文就是在变化的，也就是说只要一个任务一运行，那么保存它的运行上下文的变量 (fcontext_t) 就失效了，也就是每运行一次就要更新一次，什么时候更新呢，就是本次运行暂停的时候更新，也就是调用 jump_fcontext 跳到其他地方的时候，也就是说目标任务要更新本任务的运行上下文变量，目标任务激活的时候表现为从它的 jump_fcontext 返回 (<strong>实际上不是它返回，而是本务跳到那去执行</strong>)，返回值中的 fcontext_t 就是跳之前的运行上下文，也就是本任务的最新的运行上下文，为了更新本任务的运行上下文变量，需要把本任务的运行上下文变量的地址传递给目标任务，这需要借助 jump_fcontext 的 vp 参数，它也会出现在目标任务返回的 transfer_t 中，这就是参数 vp 和返回值 transfer_t 的作用吧，当然借助 vp 还可以传递更多需要交互的信息。</p>
<p>每一个普通任务都是通过 make_fcontext 创造出来的，但主任务 (main 函数) 不是，主任务切换到了其他任务执行，如果想切换回主任务，就必须获取主任务的运行上下文，fn 函数本来只需要自己运行的数据就够了，而它的参数 transfer_t 还带一个 fcontext，就是干这件事用的，它是最新的切换之前的运行上下文，谁启动的它，就更新谁，一个任务切换到一个曾经运行过的任务的时候一定是跳到 jump_fcontext 的下条指令，可以通过” 返回” 的 transfer_t 来实现更新，但是对于新任务，不会从 jump_fcontext 继续执行，不会得到” 返回” 的 transfer_t，就需要利用参数传递的 transfer_t 更新。</p>
<p>主任务启动 -&gt; task0 -&gt; jump_fcontext , task0 恢复执行，这时候返回的 transfer_t 不一定是主任务的运行上下文，因为它是切换 task0 任务，使 task0 再次运行的那个任务的运行上下文，那个任务未必是主任务，主任务只是第一次启动 task0 的时候的任务，并不一定是后续激活 task0 的任务。</p>
<p>如果 fn 函数运行完成，没有通过 jump_fcontext 切换任务，直接返回，那么结果是整个进程都退出了，因为它返回之后是返回到了 make_fcontext 的一段代码中，那段代码的操作是退出进程。从 gdb 里用 bt 可以看到，一个任务的调用者是 make_fcontext，而不是启动它或再次激活它的时候对应的函数，这是因为 make_fcontext 里面设置这个函数的时候同时设置好了它的返回地址，所以如果不想退出进程，一个任务完成的时候需要跳到其他任务，然后释放保存本任务的栈空间资源，需要注意的是释放是要在别的地方释放 (s_task 库中有一个 join 任务的地方)，而不能在跳转之前释放，因为跳转的时候要保存当前运行上下文到当前的栈空间，如果释放了再跳转会造成非法地址的错误。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag"><i class="fa fa-tag"></i> 协程</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/bfc2a6f5.html" rel="prev" title="Linux 下压缩、解压命令汇总">
                  <i class="fa fa-angle-left"></i> Linux 下压缩、解压命令汇总
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/71f253a3.html" rel="next" title="Vim 可视模式下多行操作技巧">
                  Vim 可视模式下多行操作技巧 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heartbeat"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">paopao</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.20/fancybox/fancybox.umd.js" integrity="sha256-q8XkJ6dj5VwSvzI8+nATCHHQG+Xv/dAZBCgqmu93zOY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>



  <script src="/js/third-party/fancybox.js"></script>



  




<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw09gPog","appkey":"4488e6b82bfe3d819f4971a5e5c115f4","count":true}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
